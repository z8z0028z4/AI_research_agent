import React, { useState, useRef, useEffect } from 'react';
import { Card, Upload, Button, Typography, Space, message, Progress, List, Tag, Statistic, Row, Col } from 'antd';
import { InboxOutlined, FileTextOutlined, UploadOutlined, DatabaseOutlined } from '@ant-design/icons';
import axios from 'axios';

const { Title, Paragraph } = Typography;
const { Dragger } = Upload;

const UploadPage = () => {
  const [fileList, setFileList] = useState([]);
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [taskId, setTaskId] = useState(null);
  const [serverMessage, setServerMessage] = useState('');
  const [results, setResults] = useState(null);
  const [vectorStats, setVectorStats] = useState({ paper_vectors: 0, experiment_vectors: 0, total_vectors: 0 });
  const pollingRef = useRef(null);

  // Áç≤ÂèñÂêëÈáèÁµ±Ë®à‰ø°ÊÅØ
  const fetchVectorStats = async () => {
    try {
      console.log('üìä ÈñãÂßãÁç≤ÂèñÂêëÈáèÁµ±Ë®à‰ø°ÊÅØ...');
      const response = await axios.get('/api/v1/upload/stats', {
        timeout: 5000, // 5ÁßíË∂ÖÊôÇ
        headers: {
          'Content-Type': 'application/json',
        }
      });
      console.log('üìä ÂêëÈáèÁµ±Ë®àÈüøÊáâ:', response.data);
      setVectorStats(response.data);
    } catch (error) {
      console.error('‚ùå Áç≤ÂèñÂêëÈáèÁµ±Ë®àÂ§±Êïó:', error);
      // Â¶ÇÊûúÊòØÁ∂≤Áµ°ÈåØË™§ÔºåË®≠ÁΩÆÈªòË™çÂÄº
      if (error.code === 'ECONNREFUSED' || error.code === 'ERR_NETWORK') {
        console.log('‚ö†Ô∏è ÂæåÁ´Ø‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÈªòË™çÁµ±Ë®à');
        setVectorStats({ paper_vectors: 0, experiment_vectors: 0, total_vectors: 0 });
      }
    }
  };

  // Âà∑Êñ∞ÂêëÈáèÁµ±Ë®à‰ø°ÊÅØÔºàÈáçÊñ∞Ë®àÁÆóÔºâ
  const refreshVectorStats = async () => {
    try {
      console.log('üîÑ ÈñãÂßãÂà∑Êñ∞ÂêëÈáèÁµ±Ë®à‰ø°ÊÅØ...');
      const response = await axios.post('/api/v1/upload/refresh-stats', {}, {
        timeout: 10000, // 10ÁßíË∂ÖÊôÇÔºåÂõ†ÁÇ∫ÈúÄË¶ÅÈáçÊñ∞Ë®àÁÆó
        headers: {
          'Content-Type': 'application/json',
        }
      });
      console.log('üîÑ ÂêëÈáèÁµ±Ë®àÂà∑Êñ∞ÈüøÊáâ:', response.data);
      setVectorStats(response.data);
    } catch (error) {
      console.error('‚ùå Âà∑Êñ∞ÂêëÈáèÁµ±Ë®àÂ§±Êïó:', error);
      // Â¶ÇÊûúÂà∑Êñ∞Â§±ÊïóÔºåÂòóË©¶Áç≤ÂèñÁ∑©Â≠òÊï∏Êìö
      fetchVectorStats();
    }
  };

  // È†ÅÈù¢Âä†ËºâÊôÇÁç≤ÂèñÁµ±Ë®à‰ø°ÊÅØÔºàÁèæÂú®‰ΩøÁî®ÂæåÁ´ØÁ∑©Â≠òÔºåÈüøÊáâÊõ¥Âø´Ôºâ
  useEffect(() => {
    fetchVectorStats();
  }, []);

  const handleUpload = async () => {
    if (fileList.length === 0) {
      message.warning('Please select files to upload');
      return;
    }

    console.log('üöÄ ÈñãÂßãÊñá‰ª∂‰∏äÂÇ≥ÊµÅÁ®ã...');
    console.log('üìÅ ÈÅ∏‰∏≠ÁöÑÊñá‰ª∂:', fileList.map(f => f.name));

    setUploading(true);
    setUploadProgress(0);
    setServerMessage('');
    setResults(null);

    try {
      const formData = new FormData();
      fileList.forEach((file) => {
        formData.append('files', file);
        console.log('üìÑ Ê∑ªÂä†Êñá‰ª∂Âà∞FormData:', file.name, 'Â§ßÂ∞è:', file.size);
      });

      console.log('üì§ ÈñãÂßã‰∏äÂÇ≥Êñá‰ª∂Âà∞ÂæåÁ´Ø...');
      const resp = await axios.post('/api/v1/upload/files', formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
        onUploadProgress: (evt) => {
          // ÁßªÈô§Êñá‰ª∂‰∏äÂÇ≥ÈÄ≤Â∫¶È°ØÁ§∫ÔºåÂè™È°ØÁ§∫Â∑•‰ΩúÊµÅÁ®ãÈÄ≤Â∫¶
          // Êñá‰ª∂‰∏äÂÇ≥ÂÆåÊàêÂæåÔºåÈÄ≤Â∫¶Ê¢ùÊúÉÂæûÂæåÁ´ØÊõ¥Êñ∞
        },
      });

      console.log('‚úÖ Êñá‰ª∂‰∏äÂÇ≥ÊàêÂäüÔºåÈüøÊáâ:', resp.data);
      const { file_info } = resp.data;
      const newTaskId = file_info?.task_id;
      console.log('üÜî ‰ªªÂãôID:', newTaskId);
      setTaskId(newTaskId);
      message.success('Upload started. Processing on server...');

      // ÈñãÂßãËº™Ë©¢‰ªªÂãôÁãÄÊÖã
      const poll = async () => {
        try {
          console.log('üîÑ ÈñãÂßãËº™Ë©¢‰ªªÂãôÁãÄÊÖã:', newTaskId);
          const statusResp = await axios.get(`/api/v1/upload/status/${newTaskId}`);
          const { status, progress, message: msg, results: r } = statusResp.data;
          
          console.log('üìä ÂæåÁ´ØÁãÄÊÖãÈüøÊáâ:', {
            status,
            progress,
            message: msg,
            hasResults: !!r
          });
          
          // Áõ¥Êé•ÂêåÊ≠•ÂæåÁ´ØÈÄ≤Â∫¶ÔºöÂæåÁ´ØÈÄ≤Â∫¶Â∞±ÊòØÂâçÁ´ØÈÄ≤Â∫¶
          // ËôïÁêÜprogressÂèØËÉΩÁÇ∫nullÊàñundefinedÁöÑÊÉÖÊ≥Å
          const safeProgress = progress !== null && progress !== undefined ? progress : 0;
          // Áõ¥Êé•‰ΩøÁî®ÂæåÁ´ØÈÄ≤Â∫¶Ôºå‰∏çÂÜçËΩâÊèõ
          const backendProgress = safeProgress;
          console.log('üìà ÈÄ≤Â∫¶ÂêåÊ≠•:', {
            ÂæåÁ´ØÈÄ≤Â∫¶: progress,
            ÂÆâÂÖ®ÈÄ≤Â∫¶: safeProgress,
            ÂâçÁ´ØÈÄ≤Â∫¶: backendProgress,
            Ë™™Êòé: 'Áõ¥Êé•ÂêåÊ≠•ÂæåÁ´ØÈÄ≤Â∫¶'
          });
          
          // Á¢∫‰øùÈÄ≤Â∫¶‰∏çÊúÉÂÄíÈÄÄÔºåÂè™ÊúÉÂêëÂâçÊõ¥Êñ∞
          setUploadProgress(prevProgress => {
            const newProgress = Math.max(prevProgress, backendProgress);
            if (newProgress !== prevProgress) {
              console.log(`üìà ÈÄ≤Â∫¶Êõ¥Êñ∞: ${prevProgress}% ‚Üí ${newProgress}%`);
            }
            return newProgress;
          });
          setServerMessage(msg || '');
          
          if (status === 'completed') {
            console.log('‚úÖ ‰ªªÂãôÂÆåÊàêÔºåÁµêÊûú:', r);
            setResults(r || {});
            setUploading(false);
            setFileList([]);
            setTaskId(null);
            setUploadProgress(100);
            pollingRef.current && clearTimeout(pollingRef.current);
            message.success('Processing completed.');
            // Êõ¥Êñ∞Áµ±Ë®à‰ø°ÊÅØ
            fetchVectorStats();
            return;
          }
          if (status === 'failed' || status === 'cancelled') {
            console.log('‚ùå ‰ªªÂãôÂ§±ÊïóÊàñÂèñÊ∂à:', status, msg);
            setUploading(false);
            setTaskId(null);
            pollingRef.current && clearTimeout(pollingRef.current);
            message.error(msg || 'Processing failed');
            return;
          }
          
          console.log('‚è≥ ‰ªªÂãôÈÄ≤Ë°å‰∏≠ÔºåÁπºÁ∫åËº™Ë©¢...');
          // ÁπºÁ∫åËº™Ë©¢ÔºåÁ∏ÆÁü≠Ëº™Ë©¢ÈñìÈöî‰ª•Êõ¥È†ªÁπÅÂú∞Êõ¥Êñ∞ÈÄ≤Â∫¶
          pollingRef.current = setTimeout(poll, 500);
        } catch (e) {
          console.error('‚ùå Ëº™Ë©¢ÁãÄÊÖãÂ§±Êïó:', e);
          pollingRef.current && clearTimeout(pollingRef.current);
          setUploading(false);
          setTaskId(null);
          message.error('Failed to get processing status');
        }
      };
      poll();

    } catch (error) {
      console.error('‚ùå Êñá‰ª∂‰∏äÂÇ≥Â§±Êïó:', error);
      message.error('Upload failed');
      setUploading(false);
      setUploadProgress(0);
    }
  };

  const uploadProps = {
    name: 'file',
    multiple: true,
    fileList: fileList,
    beforeUpload: (file) => {
      // Check file type
      const isAccepted = file.type === 'application/pdf' || 
                        file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
                        file.type === 'application/vnd.ms-excel' ||
                        file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                        file.type === 'text/plain';
      
      if (!isAccepted) {
        message.error('You can only upload PDF, Word, Excel, or text files!');
        return false;
      }

      // Check file size (10MB limit)
      const isLt10M = file.size / 1024 / 1024 < 10;
      if (!isLt10M) {
        message.error('File must be smaller than 10MB!');
        return false;
      }

      setFileList(prev => [...prev, file]);
      return false; // Prevent default upload behavior
    },
    onRemove: (file) => {
      setFileList(prev => prev.filter(item => item.uid !== file.uid));
    },
  };

  const getFileIcon = (file) => {
    if (file.type === 'application/pdf') {
      return <FileTextOutlined style={{ color: '#ff4d4f' }} />;
    } else if (file.type.includes('word')) {
      return <FileTextOutlined style={{ color: '#1890ff' }} />;
    } else if (file.type.includes('excel')) {
      return <FileTextOutlined style={{ color: '#52c41a' }} />;
    } else {
      return <FileTextOutlined style={{ color: '#faad14' }} />;
    }
  };

  return (
    <div>
      <Title level={2}>File Upload</Title>
      <Paragraph>
        Upload research papers, documents, and data files for analysis and processing.
      </Paragraph>

      {/* ÂêëÈáèÊï∏ÊìöÂ∫´Áµ±Ë®à‰ø°ÊÅØ */}
      <Card 
        title="Vector Database Statistics" 
        style={{ marginBottom: 24 }}
        extra={
          <Button 
            type="primary" 
            size="small" 
            onClick={refreshVectorStats}
            icon={<DatabaseOutlined />}
          >
            Refresh
          </Button>
        }
      >
        <Row gutter={16}>
          <Col span={8}>
            <Statistic
              title="Total Vector Chunks"
              value={vectorStats.total_vectors}
              prefix={<DatabaseOutlined />}
              valueStyle={{ color: '#1890ff' }}
            />
          </Col>
          <Col span={8}>
            <Statistic
              title="Paper Vectors"
              value={vectorStats.paper_vectors}
              prefix={<FileTextOutlined />}
              valueStyle={{ color: '#52c41a' }}
            />
          </Col>
          <Col span={8}>
            <Statistic
              title="Experiment Vectors"
              value={vectorStats.experiment_vectors}
              prefix={<DatabaseOutlined />}
              valueStyle={{ color: '#faad14' }}
            />
          </Col>
        </Row>
      </Card>

      <Card title="Upload Files" style={{ marginBottom: 24 }}>
        <Dragger {...uploadProps} disabled={uploading}>
          <p className="ant-upload-drag-icon">
            <InboxOutlined />
          </p>
          <p className="ant-upload-text">Click or drag files to this area to upload</p>
          <p className="ant-upload-hint">
            Support for PDF, Word, Excel, and text files. Max file size: 10MB
          </p>
        </Dragger>

        {fileList.length > 0 && (
          <div style={{ marginTop: 16 }}>
            <List
              size="small"
              dataSource={fileList}
              renderItem={(file) => (
                <List.Item>
                  <List.Item.Meta
                    avatar={getFileIcon(file)}
                    title={file.name}
                    description={`${(file.size / 1024 / 1024).toFixed(2)} MB`}
                  />
                </List.Item>
              )}
            />
          </div>
        )}

        {uploading && (
          <div style={{ marginTop: 16 }}>
            <Progress 
              percent={uploadProgress} 
              status="active" 
              strokeColor={{
                '0%': '#108ee9',
                '100%': '#87d068',
              }}
              format={(percent) => `${percent}%`}
            />
            {serverMessage && (
              <div style={{ marginTop: 8 }}>
                <Paragraph style={{ margin: 0, color: '#1890ff' }}>
                  {serverMessage}
                </Paragraph>
                {/* Ê†πÊìöÈÄ≤Â∫¶È°ØÁ§∫ËôïÁêÜÈöéÊÆµ */}
                <div style={{ marginTop: 4 }}>
                  {uploadProgress >= 0 && uploadProgress < 25 && (
                    <Tag color="blue">üîç Êñá‰ª∂ÂàÜÊûêÈöéÊÆµ</Tag>
                  )}
                  {uploadProgress >= 25 && uploadProgress < 50 && (
                    <Tag color="orange">üìÑ ÂÖÉÊï∏ÊìöÊèêÂèñÈöéÊÆµ</Tag>
                  )}
                  {uploadProgress >= 50 && uploadProgress < 95 && (
                    <Tag color="green">üî¢ ÂêëÈáèÂµåÂÖ•ÈöéÊÆµ</Tag>
                  )}
                  {uploadProgress >= 95 && uploadProgress < 98 && (
                    <Tag color="cyan">üìä Áµ±Ë®àÊõ¥Êñ∞ÈöéÊÆµ</Tag>
                  )}
                  {uploadProgress >= 98 && uploadProgress < 100 && (
                    <Tag color="purple">üéØ ÂÆåÊàêËôïÁêÜÈöéÊÆµ</Tag>
                  )}
                  {uploadProgress === 100 && (
                    <Tag color="success">‚úÖ ËôïÁêÜÂÆåÊàê</Tag>
                  )}
                </div>
                {/* Ê†πÊìöÊ∂àÊÅØÂÖßÂÆπÈ°ØÁ§∫Ë©≥Á¥∞ÁãÄÊÖã */}
                {uploadProgress > 0 && uploadProgress < 100 && (
                  <div style={{ marginTop: 4 }}>
                    {(serverMessage.includes('ÂàÜÊûêÊñá‰ª∂È°ûÂûã') || serverMessage.includes('ÈñãÂßãËôïÁêÜË´ñÊñáË≥áÊñô')) && (
                      <Tag color="blue">üîç Êñá‰ª∂ÂàÜÊûê</Tag>
                    )}
                    {(serverMessage.includes('ÊèêÂèñÊñá‰ª∂ÂÖÉÊï∏Êìö') || serverMessage.includes('ÊèêÂèñÁ¨¨') && serverMessage.includes('ÂÄãÊñá‰ª∂ÂÖÉÊï∏Êìö')) && (
                      <Tag color="blue">üìÑ ÊèêÂèñÊñá‰ª∂ÂÖÉÊï∏Êìö</Tag>
                    )}
                    {(serverMessage.includes('Ê™¢Êü•') && serverMessage.includes('ÈáçË§á')) && (
                      <Tag color="orange">üîç Ê™¢Êü•Êñá‰ª∂ÈáçË§á</Tag>
                    )}
                    {(serverMessage.includes('ÈñãÂßãÊñá‰ª∂ÂàÜÂ°äËôïÁêÜ') || (serverMessage.includes('ËôïÁêÜÁ¨¨') && serverMessage.includes('ÂÄãÊñá‰ª∂Ôºö'))) && (
                      <Tag color="cyan">üìö Êñá‰ª∂ÂàÜÂ°äËôïÁêÜ</Tag>
                    )}
                    {(serverMessage.includes('ÈñãÂßãÂêëÈáèÂµåÂÖ•') || serverMessage.includes('ÂêëÈáèÂµåÂÖ•ÊâπÊ¨°')) && (
                      <Tag color="green">üî¢ ÂêëÈáèÂµåÂÖ•ËôïÁêÜ</Tag>
                    )}
                    {(serverMessage.includes('ËôïÁêÜÂØ¶È©óË≥áÊñô') || serverMessage.includes('ËôïÁêÜÂØ¶È©óÊñá‰ª∂')) && (
                      <Tag color="purple">üß™ ËôïÁêÜÂØ¶È©óÊï∏Êìö</Tag>
                    )}
                    {serverMessage.includes('ÂÆåÊàêËôïÁêÜ') && (
                      <Tag color="success">‚úÖ ÂÆåÊàêËôïÁêÜ</Tag>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        <div style={{ marginTop: 16 }}>
          <Space>
            <Button
              type="primary"
              icon={<UploadOutlined />}
              onClick={handleUpload}
              loading={uploading}
              disabled={fileList.length === 0}
            >
              {uploading ? 'Uploading...' : 'Upload Files'}
            </Button>
            <Button 
              onClick={() => setFileList([])}
              disabled={fileList.length === 0 || uploading}
            >
              Clear All
            </Button>
          </Space>
        </div>
      </Card>

      {results && (
        <Card title="Processing Results" style={{ marginBottom: 24 }}>
          <Paragraph>Embedding finished. Summary:</Paragraph>
          <ul>
            {results.file_info && (
              <li>
                Files classified: 
                <Space size="small" style={{ marginLeft: 8 }}>
                  <Tag color="blue">papers: {results.file_info.papers?.length || 0}</Tag>
                  <Tag color="green">experiments: {results.file_info.experiments?.length || 0}</Tag>
                  {results.file_info.others && results.file_info.others.length > 0 && (
                    <Tag>others: {results.file_info.others.length}</Tag>
                  )}
                </Space>
              </li>
            )}
            {Array.isArray(results.paper_results) && (
              <li>Paper metadata processed: {results.paper_results.length}</li>
            )}
            {Array.isArray(results.experiment_results) && (
              <li>Experiment txt embedded: {results.experiment_results.reduce((acc, x) => acc + (x.embedded_count || 0), 0)}</li>
            )}
            {results.vector_stats && (
              <li>
                Vector chunks in database: 
                <Space size="small" style={{ marginLeft: 8 }}>
                  <Tag color="blue">papers: {results.vector_stats.paper_vectors || 0}</Tag>
                  <Tag color="green">experiments: {results.vector_stats.experiment_vectors || 0}</Tag>
                </Space>
              </li>
            )}
          </ul>
        </Card>
      )}

      <Card title="Upload Guidelines">
        <ul>
          <li>Supported file types: PDF, Word (.docx), Excel (.xlsx), and text files</li>
          <li>Maximum file size: 10MB per file</li>
          <li>Files will be processed for text extraction and analysis</li>
          <li>Uploaded files will be stored securely and can be accessed later</li>
        </ul>
      </Card>
    </div>
  );
};

export default UploadPage; 