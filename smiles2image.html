<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMILES to Image Converter</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip for creating zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- RDKit.js for cheminformatics -->
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
    
    <style>
        /* Custom styles for a clean, scientific look */
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">SMILES to Image Converter</h1>
            <p class="text-md text-gray-600 mt-2">Convert chemical SMILES strings into 2D structure images.</p>
        </header>

        <main class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <div id="loader-container" class="text-center p-8">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                <p class="mt-4 text-gray-600">Initializing RDKit Chemistry Module...</p>
            </div>
            
            <div id="app-content" class="hidden">
                <div class="mb-6">
                    <label for="smiles-input" class="block text-lg font-semibold mb-2 text-gray-700">Enter Chemical Data</label>
                    <p class="text-sm text-gray-500 mb-3">
                        Enter one chemical per line. Format: <code class="bg-gray-200 p-1 rounded-md">Chemical Name,SMILES_String</code>
                    </p>
                    <textarea id="smiles-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow" 
                    placeholder="Aspirin,CC(=O)OC1=CC=CC=C1C(=O)O&#10;Caffeine,CN1C=NC2=C1C(=O)N(C(=O)N2C)C&#10;Ethanol,CCO"></textarea>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                     <button id="generate-btn" class="w-full sm:w-auto flex-grow bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Generate Images
                    </button>
                    <button id="download-btn" class="w-full sm:w-auto flex-grow bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        Download All as ZIP
                    </button>
                </div>
            </div>
        </main>

        <section id="results-container" class="mt-8">
            <!-- Generated images will be appended here -->
        </section>

    </div>

    <script>
        // Store generated images data for zipping
        let generatedImages = [];

        // --- RDKit Initialization ---
        window
            .initRDKitModule()
            .then(function (RDKit) {
                console.log("RDKit version: " + RDKit.version());
                window.RDKit = RDKit;
                // Hide loader and show the main application content
                document.getElementById('loader-container').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
            })
            .catch(() => {
                // Handle error loading RDKit
                const loaderContainer = document.getElementById('loader-container');
                loaderContainer.innerHTML = '<p class="text-red-500 font-bold">Error: Could not load the RDKit chemistry module. Please check your internet connection and try again.</p>';
            });

        // --- DOM Element References ---
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const smilesInput = document.getElementById('smiles-input');
        const resultsContainer = document.getElementById('results-container');

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleImageGeneration);
        downloadBtn.addEventListener('click', handleDownloadZip);
        
        // --- Core Functions ---

        /**
         * Sanitizes a string to be a valid filename.
         * @param {string} name - The input string.
         * @returns {string} The sanitized filename.
         */
        function sanitizeFilename(name) {
            // Replace spaces with underscores and remove characters that are invalid in filenames
            return name.trim().replace(/\s+/g, '_').replace(/[\\/*?:"<>|]/g, '');
        }

        /**
         * Converts an SVG string to a PNG data URL using a canvas.
         * @param {string} svgData - The SVG string.
         * @param {number} width - The desired width of the PNG.
         * @param {number} height - The desired height of the PNG.
         * @returns {Promise<string>} A promise that resolves with the PNG data URL.
         */
        function svgToPngDataURL(svgData, width, height) {
            return new Promise((resolve) => {
                const img = new Image();
                // Browsers need the SVG data to be base64 encoded to be used as an image source
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    
                    // Fill background with white
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
                
                img.src = url;
            });
        }
        
        /**
         * Main function to handle parsing input and generating images.
         */
        async function handleImageGeneration() {
            if (!window.RDKit) {
                alert("RDKit is not initialized. Please wait or reload the page.");
                return;
            }

            const inputText = smilesInput.value.trim();
            if (!inputText) {
                alert("Please enter chemical data.");
                return;
            }

            // Clear previous results and disable buttons during processing
            resultsContainer.innerHTML = '<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div><p class="text-center mt-2">Generating structures...</p>';
            generatedImages = [];
            generateBtn.disabled = true;
            downloadBtn.disabled = true;

            const lines = inputText.split('\n').filter(line => line.trim() !== '');
            
            for (const line of lines) {
                // FIX: Use lastIndexOf to correctly parse names that contain commas.
                const lastCommaIndex = line.lastIndexOf(',');
                if (lastCommaIndex === -1) {
                    console.warn(`Skipping invalid line (no comma found): ${line}`);
                    continue;
                }

                const name = line.substring(0, lastCommaIndex).trim();
                const smiles = line.substring(lastCommaIndex + 1).trim();
                
                let mol = null;
                try {
                    mol = window.RDKit.get_mol(smiles);

                    // FIX: Check if mol is null before calling methods on it.
                    // This prevents the "Cannot read properties of null" error.
                    if (!mol || !mol.is_valid()) {
                       throw new Error("Invalid SMILES string");
                    }
                    
                    const svg = mol.get_svg(300, 300); // Generate a 300x300 SVG
                    const pngDataUrl = await svgToPngDataURL(svg, 300, 300);

                    generatedImages.push({
                        name: sanitizeFilename(name) + '.png',
                        dataUrl: pngDataUrl
                    });
                    
                } catch (e) {
                    console.error(`Failed to process SMILES "${smiles}" for "${name}":`, e);
                    // Create an error card for invalid SMILES
                     generatedImages.push({
                        name: sanitizeFilename(name) + '.png',
                        dataUrl: null, // Indicates an error
                        error: `Invalid SMILES: ${smiles}`
                    });
                } finally {
                    if (mol) {
                        mol.delete(); // IMPORTANT: free up memory
                    }
                }
            }

            // Display the results
            displayResults();
            generateBtn.disabled = false;
        }

        /**
         * Renders the generated images (or error messages) to the page.
         */
        function displayResults() {
            resultsContainer.innerHTML = ''; // Clear loader
            if (generatedImages.length === 0) {
                 resultsContainer.innerHTML = '<p class="text-center text-red-500">No valid chemical data found to process.</p>';
                 return;
            }

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';

            generatedImages.forEach(imgData => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col items-center text-center';

                const title = document.createElement('h3');
                title.className = 'font-semibold text-gray-700 mb-2 truncate w-full';
                title.textContent = imgData.name.replace('.png', '');

                if (imgData.dataUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.src = imgData.dataUrl;
                    imgElement.alt = `Structure of ${imgData.name}`;
                    imgElement.className = 'w-full h-auto object-contain rounded-md border border-gray-200';
                    card.appendChild(imgElement);
                } else {
                    const errorContainer = document.createElement('div');
                    errorContainer.className = 'w-full h-[300px] flex items-center justify-center bg-red-50 border border-red-200 rounded-md p-4';
                    const errorText = document.createElement('p');
                    errorText.className = 'text-red-600';
                    errorText.textContent = imgData.error || 'Failed to generate image.';
                    errorContainer.appendChild(errorText);
                    card.appendChild(errorContainer);
                }
                
                card.appendChild(title);
                grid.appendChild(card);
            });
            resultsContainer.appendChild(grid);
            
            // Enable download button if there are any valid images
            if (generatedImages.some(img => img.dataUrl)) {
                 downloadBtn.disabled = false;
            }
        }

        /**
         * Creates a ZIP file of the generated images and initiates download.
         */
        function handleDownloadZip() {
            const zip = new JSZip();
            let validImageCount = 0;

            generatedImages.forEach(imgData => {
                if(imgData.dataUrl){
                    // Extract base64 data from the data URL
                    const base64Data = imgData.dataUrl.split(',')[1];
                    zip.file(imgData.name, base64Data, { base64: true });
                    validImageCount++;
                }
            });
            
            if(validImageCount === 0){
                alert("No valid images to download.");
                return;
            }

            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "chemical_structures.zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        }
    </script>
</body>
</html>
